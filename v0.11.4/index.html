<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Home · Enzyme.jl</title><script data-outdated-warner src="assets/warner.js"></script><link rel="canonical" href="https://enzyme.mit.edu/julia/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script><script src="https://plausible.io/js/plausible.js" data-domain="enzyme.mit.edu" defer></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href><img src="assets/logo.svg" alt="Enzyme.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href>Enzyme.jl</a></span></div><form class="docs-search" action="search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>Home</a><ul class="internal"><li><a class="tocitem" href="#Getting-started"><span>Getting started</span></a></li><li><a class="tocitem" href="#Caveats-/-Known-issues"><span>Caveats / Known-issues</span></a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="generated/box/">Box model</a></li><li><a class="tocitem" href="generated/autodiff/">AutoDiff API</a></li><li><a class="tocitem" href="generated/custom_rule/">Custom rules</a></li></ul></li><li><a class="tocitem" href="api/">API</a></li><li><a class="tocitem" href="pullbacks/">Implementing pullbacks</a></li><li><a class="tocitem" href="dev_docs/">For developers</a></li><li><a class="tocitem" href="internal_api/">Internal API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Home</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Home</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/EnzymeAD/Enzyme.jl/blob/main/docs/src/index.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Enzyme"><a class="docs-heading-anchor" href="#Enzyme">Enzyme</a><a id="Enzyme-1"></a><a class="docs-heading-anchor-permalink" href="#Enzyme" title="Permalink"></a></h1><p>Documentation for <a href="https://github.com/EnzymeAD/Enzyme.jl">Enzyme.jl</a>, the Julia bindings for <a href="https://github.com/EnzymeAD/enzyme">Enzyme</a>.</p><p>Enzyme performs automatic differentiation (AD) of statically analyzable LLVM. It is highly-efficient and its ability to perform AD on optimized code allows Enzyme to meet or exceed the performance of state-of-the-art AD tools.</p><p>Enzyme.jl can be installed in the usual way Julia packages are installed:</p><pre><code class="nohighlight hljs">] add Enzyme</code></pre><p>The Enzyme binary dependencies will be installed automatically via Julia&#39;s binary actifact system.</p><p>The Enzyme.jl API revolves around the function <a href="api/#EnzymeCore.autodiff-Union{Tuple{A}, Tuple{FA}, Tuple{RABI}, Tuple{ForwardMode{RABI}, FA, Type{A}, Vararg{Any}}} where {RABI&lt;:EnzymeCore.ABI, FA&lt;:EnzymeCore.Annotation, A&lt;:EnzymeCore.Annotation}"><code>autodiff</code></a>, see its documentation for details and a usage example. Also see <a href="pullbacks/#Implementing-pullbacks">Implementing pullbacks</a> on how to use Enzyme.jl to implement back-propagation for functions with non-scalar results.</p><h2 id="Getting-started"><a class="docs-heading-anchor" href="#Getting-started">Getting started</a><a id="Getting-started-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-started" title="Permalink"></a></h2><pre><code class="language-julia-repl hljs">julia&gt; rosenbrock(x, y) = (1.0 - x)^2 + 100.0 * (y - x^2)^2
rosenbrock (generic function with 1 method)

julia&gt; rosenbrock_inp(x) = (1.0 - x[1])^2 + 100.0 * (x[2] - x[1]^2)^2
rosenbrock_inp (generic function with 1 method)</code></pre><h3 id="Reverse-mode"><a class="docs-heading-anchor" href="#Reverse-mode">Reverse mode</a><a id="Reverse-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Reverse-mode" title="Permalink"></a></h3><p>The return value of reverse mode is a tuple that contains as a first value the derivative value of the active inputs and optionally the primal return value.</p><pre><code class="language-julia-repl hljs">julia&gt; autodiff(Reverse, rosenbrock, Active, Active(1.0), Active(2.0))
((-400.0, 200.0),)

julia&gt; autodiff(ReverseWithPrimal, rosenbrock, Active, Active(1.0), Active(2.0))
((-400.0, 200.0), 100.0)</code></pre><pre><code class="language-julia-repl hljs">julia&gt; x = [1.0, 2.0]
2-element Vector{Float64}:
 1.0
 2.0

julia&gt; dx = [0.0, 0.0]
2-element Vector{Float64}:
 0.0
 0.0

julia&gt; autodiff(Reverse, rosenbrock_inp, Active, Duplicated(x, dx))
((nothing,),)

julia&gt; dx
2-element Vector{Float64}:
 -400.0
  200.0</code></pre><p>Both the inplace and &quot;normal&quot; variant return the gradient. The difference is that with <a href="api/#EnzymeCore.Active"><code>Active</code></a> the gradient is returned and with <a href="api/#EnzymeCore.Duplicated"><code>Duplicated</code></a> the gradient is accumulated in place.</p><h3 id="Forward-mode"><a class="docs-heading-anchor" href="#Forward-mode">Forward mode</a><a id="Forward-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Forward-mode" title="Permalink"></a></h3><p>The return value of forward mode with a <code>Duplicated</code> return is a tuple containing as the first value the primal return value and as the second value the derivative.</p><p>In forward mode <code>Duplicated(x, 0.0)</code> is equivalent to <code>Const(x)</code>, except that we can perform more optimizations for <code>Const</code>.</p><pre><code class="language-julia-repl hljs">julia&gt; autodiff(Forward, rosenbrock, Duplicated, Const(1.0), Duplicated(3.0, 1.0))
(400.0, 400.0)

julia&gt; autodiff(Forward, rosenbrock, Duplicated, Duplicated(1.0, 1.0), Const(3.0))
(400.0, -800.0)</code></pre><p>Of note, when we seed both arguments at once the tangent return is the sum of both.</p><pre><code class="language-julia-repl hljs">julia&gt; autodiff(Forward, rosenbrock, Duplicated, Duplicated(1.0, 1.0), Duplicated(3.0, 1.0))
(400.0, -400.0)</code></pre><p>We can also use forward mode with our inplace method.</p><pre><code class="language-julia-repl hljs">julia&gt; x = [1.0, 3.0]
2-element Vector{Float64}:
 1.0
 3.0

julia&gt; dx = [1.0, 1.0]
2-element Vector{Float64}:
 1.0
 1.0

julia&gt; autodiff(Forward, rosenbrock_inp, Duplicated, Duplicated(x, dx))
(400.0, -400.0)</code></pre><p>Note the seeding through <code>dx</code>.</p><h4 id="Vector-forward-mode"><a class="docs-heading-anchor" href="#Vector-forward-mode">Vector forward mode</a><a id="Vector-forward-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Vector-forward-mode" title="Permalink"></a></h4><p>We can also use vector mode to calculate both derivatives at once.</p><pre><code class="language-julia-repl hljs">julia&gt; autodiff(Forward, rosenbrock, BatchDuplicated, BatchDuplicated(1.0, (1.0, 0.0)), BatchDuplicated(3.0, (0.0, 1.0)))
(400.0, (var&quot;1&quot; = -800.0, var&quot;2&quot; = 400.0))

julia&gt; x = [1.0, 3.0]
2-element Vector{Float64}:
 1.0
 3.0

julia&gt; dx_1 = [1.0, 0.0]; dx_2 = [0.0, 1.0];

julia&gt; autodiff(Forward, rosenbrock_inp, BatchDuplicated, BatchDuplicated(x, (dx_1, dx_2)))
(400.0, (var&quot;1&quot; = -800.0, var&quot;2&quot; = 400.0))</code></pre><h2 id="Caveats-/-Known-issues"><a class="docs-heading-anchor" href="#Caveats-/-Known-issues">Caveats / Known-issues</a><a id="Caveats-/-Known-issues-1"></a><a class="docs-heading-anchor-permalink" href="#Caveats-/-Known-issues" title="Permalink"></a></h2><h3 id="Activity-of-temporary-storage"><a class="docs-heading-anchor" href="#Activity-of-temporary-storage">Activity of temporary storage</a><a id="Activity-of-temporary-storage-1"></a><a class="docs-heading-anchor-permalink" href="#Activity-of-temporary-storage" title="Permalink"></a></h3><p>If you pass in any temporary storage which may be involved in an active computation to a function you want to differentiate, you must also pass in a duplicated temporary storage for use in computing the derivatives. </p><pre><code class="language-julia hljs">function f(x, tmp, n)
    tmp[1] = 1
    for i in 1:n
        tmp[1] *= x
    end
    tmp[1]
end

# Incorrect [ returns (0.0,) ]
Enzyme.autodiff(f, Active(1.2), Const(Vector{Float64}(undef, 1)), Const(5))

# Correct [ returns (10.367999999999999,) == 1.2^4 * 5 ]
Enzyme.autodiff(f, Active(1.2), Duplicated(Vector{Float64}(undef, 1), Vector{Float64}(undef, 1)), Const(5))</code></pre><h3 id="CUDA.jl-support"><a class="docs-heading-anchor" href="#CUDA.jl-support">CUDA.jl support</a><a id="CUDA.jl-support-1"></a><a class="docs-heading-anchor-permalink" href="#CUDA.jl-support" title="Permalink"></a></h3><p><a href="https://github.com/JuliaGPU/CUDA.jl">CUDA.jl</a> is only supported on Julia v1.7.0 and onwards. On v1.6, attempting to differentiate CUDA kernel functions will not use device overloads correctly and thus returns fundamentally wrong results.</p><h3 id="Sparse-Arrays"><a class="docs-heading-anchor" href="#Sparse-Arrays">Sparse Arrays</a><a id="Sparse-Arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Sparse-Arrays" title="Permalink"></a></h3><p>At the moment there is limited support for sparse linear algebra operations. Sparse arrays may be used, but care must be taken because backing arrays drop zeros in Julia (unless told not to).</p><pre><code class="language-julia hljs">using SparseArrays

a=sparse([2.0])
f(a)=sum(a)

# Incorrect: SparseMatrixCSC drops explicit zeros
# returns 1-element SparseVector{Float64, Int64} with 0 stored entries
da=sparse([0.0])

# Correct: Prevent SparseMatrixCSC from dropping zeros
# returns 1-element SparseVector{Float64, Int64} with 1 stored entry:
#  [1]  =  0.0
da=sparsevec([1], [0.0])

Enzyme.autodiff(Reverse, f, Active, Duplicated(a, da))
@show da</code></pre></article><nav class="docs-footer"><a class="docs-footer-nextpage" href="generated/box/">Box model »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Friday 7 July 2023 19:11">Friday 7 July 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
